<!DOCTYPE html>
<html>
<body>
	<div class="content" >
		<div th:insert="index"></div>
		<!-- Scrollable div with main content -->

			<div class="row" id="rowStart" style="width:100%">
				<div class="col-xs-12 col-md-5">
				<div class="pageClass">
					<h1>
						Analysis
					</h1>
					<h3>Gene input</h3>


					<div id="query">
						<textarea class="comments" id="queryText"
								style="width: 90%; height: 90px;" oninput="printText()">Put here the official gene symbol...</textarea>
							<script>
								$("#queryText")
										.click(
												function() {
													if ($.trim($(this).val()) === "Put here the official gene symbol...") {
														$(this).val("");
													};
													return false;
												})
								function printText() {
									var x = document
											.getElementById("queryText").value
											.split(/[\s|\n|\t|;|,]/g);
									if (x.length > 5) {
										$("#support")
												.val(
														""+ (Math.floor(Math.sqrt(Math.abs(x.length / 10 - 1))) + 2));
									} else {
										$("#support").val("" + 1);
									}
								}
							</script>


							 <i class="fa fa-info-circle" rel="tooltip" data-html="true"
								title="Gene input" data-content="The gene input consider only the official gene symbol. The genes can be delimited by:<br>

								&nbsp;	1. Space<br>
								&nbsp;	2. Tabulation<br>
								&nbsp;	3. Line breaks<br>
								&nbsp;	4. Comma<br>
								&nbsp;	5. Semicolon<br>

									It is possible to insert a file in text-plain format."
></i>
						<br>
						<button id="clear">Clear</button>
						<script>

						$("#clear").click(function(){
							$("#queryText").val("Put here the official gene symbol...")
						});

						</script>
						<h6>OR insert a file in csv, tsv or txt file</h6>
						<input type="file" id="queryFile" name="profile_pic"
							accept=".csv, .tsv, .txt">

					</div>
					<h3>Genome annotation input</h3>
					<div>
						<br> <label style="font-weight: normal;">Choose an
							organisme: <SELECT id="organism" name="organism" size="1">
								<OPTION value="homo_sapiens" selected>homo_sapiens
								<OPTION value="danio_rerio">danio_rerio
								<OPTION value="saccharomyces_cerevisiae">saccharomyces_cerevisiae


								<OPTION value="escherichia_coli">escherichia_coli
								<OPTION value="mus_musculus">mus_musculus
								<OPTION value="arabidopsis_thaliana">arabidopsis_thaliana



								<OPTION value="canis_lupus">canis_lupus
								<OPTION value="sus_scrofa">sus_scrofa
								<OPTION value="rattus_norvegicus">rattus_norvegicus
								<OPTION value="gallus_gallus">gallus_gallus
								<OPTION value="candida_albicans">candida_albicans
								<OPTION value="bos_taurus">bos_taurus
								<OPTION value="drosophila_melanogaster">drosophila_melanogaster


								<OPTION value="caenorhabditis_elegans">caenorhabditis_elegans



								<OPTION value="input">input
						</SELECT>
						</label> <span> <i class="fa fa-info-circle" rel="tooltip"
							title="Select genome" data-content="Choose the stored organism. If your organism is not in the list, you can choose input and upload a GOA using the gaf 2.0 format."
							></i>
						</span> <br>
						<div id="gafHide" style="display: none">
							<p>Please, use a gaf file format.</p>
							<input type="file" id="GAF" name="GAF"> <br>
						</div>
						<script>

							 if($("#organism").val()== "input"){

								 $("#gafHide").show();
	 							//$('#prok').bootstrapToggle('enable')
	 							} else{
	 							$("#gafHide").hide();
							}
							 $("#organism").change(function(event) {

							 if(event.target.value == "input"){
							$("#gafHide").show();
							 //$('#prok').bootstrapToggle('enable')
							 } else{
							$("#gafHide").hide();
							// $('#prok').bootstrapToggle('disable')
							 }


							 });

						</script>

						<br>
						<div>
							<!--   Prokaryote:&nbsp;

      <input id="prok" value="off" disabled="disabled" data-toggle="toggle" data-onstyle="primary" data-size = "mini" type="checkbox">
        <i class="fa fa-info-circle"  rel="tooltip" title="Popover Header" data-content="Some content inside the popover"></i> &nbsp; &nbsp;
        -->
							Considering IEA:&nbsp; <input id="iea" checked
								data-toggle="toggle" data-onstyle="primary" data-size="mini"
								type="checkbox"> <i class="fa fa-info-circle"
								rel="tooltip" title="Infered Electronic Analysis" data-content="Choose if the annotation with IEA evidence are considered or not in the analysis. IEA are annotation created without curator review."></i>

						</div>
						<br> <label style="font-weight: normal;">Choose an
							ontology: <i class="fa fa-info-circle" rel="tooltip"
							title="Select Ontology" data-content="Subparts of GO (BP, MF, CC, all) to choose for the analysis."></i>
						</label> <br> <input class="ontologies" id="BP" type="checkbox"
							value="GO:0008150" checked="checked"> <label for="BP">biological_process</label>
						<input class="ontologies" id="MF" type="checkbox"
							value="GO:0003674"> <label for="MF">molecular_function</label>
						<input class="ontologies" id="CC" type="checkbox"
							value="GO:0005575"> <label for="CC">cellular_component</label>
					<!--	<input class="ontologies" id="DO" type="checkbox"
							value="DOID:4"> <label for="DO">disease</label>
						<input class="ontologies" id="R" type="checkbox"
							value="reac"> <label for="R">reactome</label>-->
						<!--
						<input class="ontologies" id="all" type="checkbox" value="all">

						<label for="all">all </label>
						-->
						<!-- (doesn't work) -->



						<br> <label style="font-weight: normal;">Choose an
							semantic similarity method: <SELECT id="semantic_similarity"
							name="semantic_similarity" size="1">
								<OPTION value="simrel">SimRel
								<OPTION value="lin">Lin
								<OPTION value="resnik">Resnik
								<OPTION value="pekarStaab">Pekar & Staab
								<OPTION value="distanceFunction">Distance function
								<OPTION value="ganesan">Ganesan
								<OPTION value="nUnivers">NUnivers
									<!--  <OPTION value="NUM">NUnivers_Mod  -->
								<OPTION value="aic" selected>AIC

									<!--  <OPTION value="wang">Wang-->
						</SELECT>
						</label> <i class="fa fa-info-circle" rel="tooltip"
							title="Semantic similarity measure" data-content="Choose the semantic similarity measure to compute the similarity between terms."></i>
						&nbsp;&nbsp;

						<h3>
							Advanced parameters
							<button type="button" class="btn btn-default btn-circle"
								id="hide" style="display: none;">
								<span class="glyphicon glyphicon-minus"></span>
							</button>
							<button type="button" class="btn btn-default btn-circle"
								id="show">
								<span class="glyphicon glyphicon-plus"></span>
							</button>
						</h3>
						<script>
							$(document).ready(function() {
								$("#hide").click(function() {
									$(".container-fluid").hide();
									$("#show").show();
									$("#hide").hide();
								});
								$("#show").click(function() {
									$(".container-fluid").show();
									$("#show").hide();
									$("#hide").show();
								});
							});
						</script>

						<div class="container-fluid" style="display: none;">
							<div class="row">
								<div class="col-sm-4">
									<label style="font-weight: normal;"> Information
										content: </label> <SELECT id="ic" name="ic" size="1">
										<OPTION value="0">Seco
										<OPTION value="1">Zhou
										<OPTION value="2">Sanchez
										<OPTION value="3" selected>Mazandu

											<!--  <OPTION value="wang">Wang-->
									</SELECT> <i class="fa fa-info-circle" rel="tooltip" title="IC" data-content="Choose the measure to compute the information content score."></i>
									&nbsp;&nbsp;


								</div>
							</div>
							<br>
							<div class="row">
								<div class="col-xs-8 col-sm-6">
									<h4 style="font-weight: bold;">Filters:</h4>

					<!--				<div class="form-group row">
										<label class="col-xs-12 col-lg-8 col-form-label"
											style="font-weight: normal;">Clustering gene
											covering: <i class="fa fa-info-circle" rel="tooltip"
											title="## Gene covering ##
In the representative algorithm, after clustering method, one or more terms can represent the cluster. A cluster involve a number of genes being the addition of its elements. This filter allow to be permissive for each clustering being able to show a more specific representative involving at least the chosen filter value."></i>
										</label>


										<div class="col-xs-12 col-sm-8 col-md-8 col-lg-4">
											<input class="form-control" type="number" id="covering"
												value=1 min=0 max=1 step="0.01" maxlength="4" size="4">

										</div>
									</div>-->

									<div class="form-group row">
										<label class="col-xs-12 col-lg-8 col-form-label"
											style="font-weight: normal;">Gene support: <i
											class="fa fa-info-circle" rel="tooltip" title="Gene support" data-content="Any term annotating less genes than the filter value will be removed. The value is adapted depending on the gene set size but can be chosen by the user."></i>
										</label>


										<div class="col-xs-12 col-sm-8 col-md-8 col-lg-4">
											<input class="form-control" type="number" id="support"
												value=3 step="1">
										</div>
									</div>

									<div class="form-group row">
										<label class="col-xs-12 col-lg-8 col-form-label"
											style="font-weight: normal;">Term combined
											similarity: <i class="fa fa-info-circle" rel="tooltip"
											title="Jaccard-like gene similarity" data-content="When the algorithm searches the representative, sometimes, more than one representative term can be found. This filter is used to have some difference between them. The similarity used is a jaccard similarity using the genes annotating for each representative terms combined."></i>
										</label>

										<div class="col-xs-12 col-sm-10 col-md-6 col-lg-4">
											<input class="form-control" type="number"
												id="similarity_filter" value=0.5 min=0 max=1 step="0.01">
										</div>
									</div>
									<div class="form-group row">
										<label class="col-xs-12 col-lg-8 col-form-label"
											style="font-weight: normal;">Percentile: <i
											class="fa fa-info-circle" rel="tooltip"
											title="Incomplete annotation - Percentile" data-content="This values is crucial to compute the incomplete annotation. Using the GO structure, we get the IC of each GO term and compute the percentile used here. All values below the IC of the percentile chosen will be removed."></i>
										</label>
										<div class="col-xs-12 col-sm-8 col-md-8 col-lg-4">
											<input class="form-control" type="number" id="percentile"
												value=25 min=1 max=100 step="1">
										</div>
									</div>


								</div>

							</div>
						</div>
					</div>



					<div class=".email">

						email (OPTIONAL):<br> <input type="text" id="inputEmail"
							name="email"><br>

					</div>
					<br>
					<button type="button" id="run" class="btn-circle btn-xl">
						<i class="glyphicon glyphicon-play"></i>
					</button>
					<span id="uploading" style="display: none;">
					Uploading GAF file: <span id="percentage"></span>
					</span>
					<span id="uploaded" style="display: none;">
						GAF file uploaded.
					</span>

					<br><br>


					<script>

						var fileGAF = "";
						$("#GAF")
								.change(
										function(e) {
											//var ext = $("input#GAF")
												//	.val().split(".").pop()
												//	.toLowerCase();

									//		if ($.inArray(ext, [ "txt", "csv",
									//				"tsv", ".gaf" ]) == -1) {
									//			alert('Please upload a .gaf,.txt,.csv or .tsv file');
									//			return false;
									//		}
                    fileGAF = e.target.files.item(0);




										});

						var genesFile = []
						$("#queryFile")
								.change(
										function(e) {
											var ext = $("input#queryFile").val()
													.split(".").pop()
													.toLowerCase();
											//console.log(ext);
											if ($.inArray(ext, [ "txt", "csv",
													"tsv" ]) == -1) {
												alert('Please upload a .txt,.csv or .tsv file');
												return false;
											}
											if (e.target.files != undefined) {
												var reader = new FileReader();
												reader.onload = function(e) {
													var csvval = e.target.result
															.split("\n");

													csvval.forEach(function(x) {
																if (x !== "") {

																	genesFile = genesFile.concat(x.split(/[\n|\t|;|,]/g));

																}
															});
												};
												reader
														.readAsText(e.target.files
																.item(0));

											}
												return false;
										});

						$("#run")
								.click(
										function() {
											var genes = [];

											if (genesFile.length === 0) { // Observamos si los genes han sido cargados en un fichero.

												genes = genes.concat(document.getElementById("queryText").value.split(/[\n|\t|;|,]/g));
												//console.log(genes);

											}
											var organism = document
													.getElementById("organism").value;

											if (genes.includes("Put here the official gene symbol...")){
												alert("Please, the gene input is required!");
											return false;
											}
											else if(genes.length ===1 && genes.includes("")){
												alert("Please, the gene input is required!");
												return false;
											}
											else if(genes.length<5){
												alert("Please, the gene input must have a minimun of 5 genes");
												return false;
											}
											else if (organism === "input" && fileGAF === ""){
												alert("Please, the annotation input is required!");
												return false;
											}
											else if (organism === "input" && fileGAF.size>150000000 ){
												alert("The maximal size allowed is 150MB, If your GAF file is bigger, please contact us.");
												return false;
											}
											else if ($('.ontologies:checked').length === 0){
												alert("Please, choose at least one ontology");
												return false;
											}
											else {

												var iea = document
														.getElementById("iea").value === "on" ? true
														: false;
												var prok = false;//document.getElementById("prok").value==="on"?true:false;
												var onto = [];

												$('.ontologies')
														.each(
																function() {
																	//var sThisVal = (this.checked ? onto.push(this.value) : "0");
																	var sThisVal = (this.checked ? onto
																			.push(this.value)
																			: "0");
																});

												var ss = document
														.getElementById("semantic_similarity").value;

												var repFilter = document
														.getElementById("similarity_filter").value;
												var gcovering = document
														.getElementById("covering").value;
												var sup = document
														.getElementById("support").value;
												var per = document
														.getElementById("percentile").value;
												var ic = document
														.getElementById("ic").value;
												var email = document
														.getElementById("inputEmail").value;
												//console.log("EMAIL " + email);
												email = email === "" ? null
														: email;
												//console.log("EMAIL " + email);
												/*
												 LY6E,IFIT1,OAS1,IFIT1,IFIT3,OAS3,IFIT3,OAS1,OASL,LOC129607,ISG15,HERC5,OAS1,MX1,BATF2,LAMP3,IFI44L,XAF1,OASL,IFI44,OAS2,TRIM6,HES4,OTOF,FLJ20035,IFITM3,IFIT3,CXCL10,EPSTI1,SERPING1,LOC26010,OAS2,RSAD2,RTP4
												 */

												/*var genes = "LY6E,IFIT1,OAS1,IFIT1,IFIT3,OAS3,IFIT3,OAS1,OASL,LOC129607,ISG15,HERC5,OAS1,MX1,"+
												 "BATF2,LAMP3,IFI44L,XAF1,OASL,IFI44,OAS2,TRIM6,HES4,OTOF,FLJ20035,IFITM3,IFIT3,"  +
												 "CXCL10,EPSTI1,SERPING1,LOC26010,OAS2,RSAD2,RTP4"*/
												//console.log(organism)
												if (organism !== "input") {
													var gf = [ genes.toString() ];
													var f = new File(gf,
															"filename.txt");

													//console.log(gf);

													var formData = new FormData();
													formData.append("query", f);
													formData.append("useIEA",iea);
													formData.append("ontology",onto);
													formData.append("organism",organism);
													formData.append("semanticSimilarity",ss);
													formData.append("simRepValue",repFilter);
													formData.append("covering",gcovering);
													formData.append("minGeneSupport",sup);
													formData.append("email",email);
													formData.append("percentile", per);
													formData.append("ic_incomplete",ic);
													formData.append("prokaryote", prok);

													var xhr = new XMLHttpRequest();
													xhr
															.open("POST",
																	window.location.protocol+"//"+window.location.host+"/gsanGet","_self");

													xhr.onload = function() {
														var popUp = window.open(xhr.responseURL,'_blank');

												//console.log(popUp)

												if (popUp == null || typeof(popUp)=='undefined') {
													alert("Your browser has activated the popup blocker. If you want to use GSAn, please disable it.")

												}
												else {
													popUp.focus();
												}
													}

													xhr.send(formData)

												} else {
													var gf = [ genes.toString() ];
													var f = new File(gf,
															"filename.txt");
													var formData = new FormData();
													formData.append("query", f);
													formData.append("useIEA",iea);
													formData.append("ontology",onto);
													formData.append("uploadFile",fileGAF);
													formData.append("semanticSimilarity",ss);
													formData.append("simRepValue",repFilter);
													formData.append("covering",gcovering);
													formData.append("minGeneSupport",sup);
													formData.append("email",email);
													formData.append("percentile", per);
													formData.append("ic_incomplete",ic);
													formData.append("prokaryote", prok);

													var xhr = new XMLHttpRequest();
													xhr
															.open("POST",
																	window.location.protocol+"//"+window.location.host+"/gsanPost","_self");


																	xhr.upload.onprogress = function(e) {
																		$("#uploading").show();
				    												if (e.lengthComputable) {
				      													var percentComplete = (e.loaded / e.total) * 100;
																				percentComplete = Math.floor(percentComplete);
																				$("#percentage").html(percentComplete);
				      												//	console.log(percentComplete + '% uploaded');
																				if(percentComplete===100){
																					$("#uploading").hide();
																					$("#uploaded").show();
																				}
				    											}
				  										};
													xhr.onload = function() {
														var popUp = window.open(xhr.responseURL,'_blank');

												//console.log(popUp)

												if (popUp == null || typeof(popUp)=='undefined') {
													alert("Your browser has activated the popup blocker. If you want to use GSAn, please disable it.")

												}
												else {
													popUp.focus();
												}
													}

													xhr.send(formData)
												}

												return false;
											}
										});
					</script>

				</div>
				</div>
				<div id="examples" class="col-xs-12 col-md-6 col-lg-5">
					<H1>Example to run GSAn</H1>


					<h3>Example 1</h3>

					<p>Set of 27 genes annotated as Interferon. This gene set was provided of a module repertoire created from several diseases data-set by <a href="https://www.nature.com/articles/nri3642" target="_blank">Chaussabel et Baldwin.</a></p>

					<button id="example1" class="btn btn-primary btn-sm"
						style="float: rigth; background-color: #4169E1;">Click to use!</button>

					<h3>Example 2</h3>

					<p>Set of 81 genes annotated as regulation of antigen presentation and immune response. This gene set was provided of a module repertoire created from five human vaccines by <a href="https://www.nature.com/articles/ni.2789" target="_blank">Li et al.</a></p>

					<button id="example2" class="btn btn-primary btn-sm"
						style="float: rigth; background-color: #4169E1;">Click to use!</button>
					<br><br>
					<script type="text/javascript">
						$("#example1").click(function() {
						var gs = "LY6E,IFIT1,OAS1,IFIT1,IFIT3,OAS3,IFIT3,OAS1,OASL,LOC129607,ISG15,HERC5,OAS1,MX1,BATF2,LAMP3,IFI44L,XAF1,OASL,IFI44,OAS2,TRIM6,HES4,OTOF,FLJ20035,IFITM3,IFIT3,CXCL10,EPSTI1,SERPING1,LOC26010,OAS2,RSAD2,RTP4,"
							$("#queryText").val(gs);
						printText();
						});
						$("#example2").click(function() {
						var gs = "NCKAP1L,THEMIS,HLA-DPB1,JUN,NFKBIA,PTPN6,TLR5,HLA-DRA,CD4,PRKCQ,PLCG1,CD247,TRBC1,FCGR1B,CCR7,TLR6,TLR10,FYB,TLR2,FCER1G,TRAT1,LILRB2,LILRB1,CLEC7A,BTLA,FYN,FGR,CD86,GRAP2,HLA-DQB1,ZAP70,PAG1,MNDA,IRAK3,LCK,DUSP6,PTPN22,PAK1,CTSH,CTLA4,LCP2,TLR4,CSK,FOS,LAT2,CARD11,HLA-DRB1,CHUK,CD24,UBASH3A,MAP2K6,TLR7,LY96,HCK,VASP,LYN,LIME1,MAPK14,MYD88,INPP5D,ITK,TRAC,SLA2,KLRK1,HLA-DMB,RPS6KA1,HLA-DQA1,MEF2C,SYK,MEF2A,TLR1,PTPRC,HLA-DOA,HLA-DOB,HLA-DMA,HLA-DPA1,CD19,CD3D,CD3E,BTK,CD3G"
							$("#queryText").val(gs);
							printText();
						});
						</script>
				</div>


		</div>

	</div>


	<!-- Tooltip boostrap clicking -->

	<script>
		//$(document).ready(function() {
			//$("[rel=tooltip]").popover({
				//placement : 'right'
		//	});
		//});

	$(document).ready(function(){
    $("[rel=tooltip]").popover({ placement: 'right'});
});
	</script>

</body>
</html>
